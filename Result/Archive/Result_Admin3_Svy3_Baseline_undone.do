clear
capture log close _all
eststo clear

cd "G:\My Drive\NCRTS Retirement Timing\Retirement_Timing\Programs"

global date "$S_DATE"
log using "G:\My Drive\NCRTS Retirement Timing\Retirement_Timing\Programs\Logs\Result_Admin3_Svy3_Baseline_$date", replace text name("Ariel")
global raw "G:\My Drive\NCRTS Retirement Timing\Retirement_Timing\RawData\"
global working "G:\My Drive\NCRTS Retirement Timing\Retirement_Timing\WorkingData\"
global output "G:\Shared drives\NCRTS Retirement Timing\Retirement_Timing\Programs\RA\output\"
*********************************************************************************************************

use "${working}Admin3_Survey3.dta", clear // using MakeData_Admin3_Survey3.do (June 2022)

********************************
*** Table 1: Summary Statistics 
********************************
/*Was generated by HR_TBL1_MEANS*/
*** Creating labels for tables

lab var admin3_eligible_normal_at_svy5 "Eligible Normal (Full Benefits)" //"Normal Eligible as of December 2017"
lab var admin3_eligible_early_at_svy5 "Eligible Early (Reduced Benefits)" // "Early Eligible as of December 2017"
lab var admin3_eligible_none_at_svy5 "Not Yet Eligible for Benefits" //"Not Eligible as of December 2017"

*** Generating table and export 

gen admin3_int_age = int(admin3_age_at_svy3)

gen admin3_int_yos = int(admin3_yos_at_svy3)

global demo "svy3_own_health_poor svy3_sphlthpoor svy3_married_partner admin3_female admin3_int_age admin3_int_yos svy3_num_kids_12 svy3_num_kids_34 svy3_num_kids_miss svy3_race_black svy3_race_hisp svy3_race_other svy3_educ_ba admin3_atype_school admin3_atype_stategovt admin3_total_salary_10K_2015"
global pension "admin3_eligible_early_at_svy3 admin3_eligible_normal_at_svy3 admin5_status_not_ret admin3_eligible_none_at_svy5 admin3_eligible_early_at_svy5 admin3_eligible_normal_at_svy5"

count
global count = r(N)


estpost tabstat  $demo $pension  , statistics(mean sd count min max) columns(statistics)
eststo means1

esttab means1 using "${output}Tbl1_Sum_Stat.csv", replace ///original file: tbl1.csv
cells("mean(fmt(3)) sd(fmt(3)) min(fmt(3)) max(fmt(3))") collabels("Mean" "SD" "MIN" "MAX") nonumbers noobs label ///
title(Table 1: Summary Statistics) refcat(svy3_own_health_poor "Measured April 2016" admin5_status_not_ret "Measured December 2017", nolabel) ///
note(Notes: The sample is derived from the NCRTS dataset and includes $count workers ages 52-64 who were actively employed as of April 2016. ///
See Data Appendix for details on full sample restrictions and variable definitions.)

 
****************************************************************************
*** Table 2: The Probability of Continued Work by Pension Eligibility Status
****************************************************************************
/*Was generated by HR_Tbl_Baseline*/

*gen admin3_int_age = int(admin3_age)

tab admin3_int_age, gen(age)

global demo "svy3_own_health_poor svy3_sphlthpoor svy3_married_partner admin3_female age2-age13 admin3_int_yos svy3_num_kids_12 svy3_num_kids_34 svy3_num_kids_miss svy3_race_black svy3_race_hisp svy3_race_other svy3_educ_ba admin3_atype_school admin3_atype_stategovt admin3_total_salary_10K_2015"
global pension "admin3_eligible_early_at_svy3 admin3_eligible_normal_at_svy3 admin5_status_not_ret admin3_eligible_none_at_svy5 admin3_eligible_early_at_svy5 admin3_just_eligible_normal_svy5 admin3_past_eligible_normal_svy5"

*** COL 1: Eligibility 

logit admin5_status_not_ret admin3_eligible_early_at_svy5 admin3_eligible_normal_at_svy5 $demo, robust

sum admin5_status_not_ret if e(sample)==1
estadd scalar ymean = r(mean)

margins, dydx(*) post

test admin3_eligible_early_at_svy5 = admin3_eligible_normal_at_svy5
estadd scalar pdiff = r(p)
eststo col1_m

*** COL 2: Eligibility X Own Health

	gen adminsvy3_interact_early_poor = admin3_eligible_early_at_svy5 * svy3_own_health_poor //==> elig_earlyxpoor
	lab var adminsvy3_interact_early_poor "Eligible early * Poor health"
	
	gen adminsvy3_interact_early_good = admin3_eligible_early_at_svy5*(1-svy3_own_health_poor) //==>elig_earlyxgood
	lab var adminsvy3_interact_early_good "Eligible early * Good health"
	
	gen adminsvy3_interact_normal_poor = admin3_eligible_normal_at_svy5*svy3_own_health_poor //==elig_normxpoor
	lab var adminsvy3_interact_normal_poor "Eligible normal * Poor health"
	
	gen adminsvy3_interact_normal_good = admin3_eligible_normal_at_svy5*(1-svy3_own_health_poor) //==>elig_normxgood
	lab var adminsvy3_interact_normal_good "Eligible normal * Good health"

logit admin5_status_not_ret adminsvy3_interact_early_poor adminsvy3_interact_normal_poor  adminsvy3_interact_early_good adminsvy3_interact_normal_good $demo, robust
 
margins, dydx(*) post

sum admin5_status_not_ret if e(sample)==1
estadd scalar ymean = r(mean)

test adminsvy3_interact_early_poor = adminsvy3_interact_normal_poor 
estadd scalar pdiff_poor = r(p)

test adminsvy3_interact_early_good = adminsvy3_interact_normal_good 
estadd scalar pdiff_good = r(p)

test adminsvy3_interact_early_poor = adminsvy3_interact_early_good
estadd scalar pearly=r(p)

test adminsvy3_interact_normal_poor =adminsvy3_interact_normal_good
estadd scalar pnorm=r(p)

eststo col2_m


esttab col1_m col2_m  using "${output}Tbl2_Prob_of_Work_by_Elig.csv", replace lab se(3) b(3)  star(* 0.10 ** 0.05 *** 0.01) ///original file: tbl_reg1
	mtitle("Eligibility" "Eligibility x Own Health") sca("ymean Mean of Dep Var" "pdiff Early = Normal" ///
	"pdiff_poor Poor Health: Early = Normal" "pdiff_good Good Health: Early = Normal" ///
	"pearly  Early: Poor Health = Good Health " "pnorm Normal: Poor Health = Good Health") ///
	 order(admin3_eligible_early_at_svy5 admin3_eligible_normal_at_svy5  ///
	adminsvy3_interact_early_poor adminsvy3_interact_normal_poor  adminsvy3_interact_early_good adminsvy3_interact_normal_good ///
	svy3_own_health_poor svy3_sphlthpoor svy3_married_partner admin3_female) ///
	keep(admin3_eligible_early_at_svy5 admin3_eligible_normal_at_svy5  ///
	adminsvy3_interact_early_poor adminsvy3_interact_normal_poor  adminsvy3_interact_early_good adminsvy3_interact_normal_good ///
	svy3_own_health_poor svy3_sphlthpoor svy3_married_partner admin3_female) margin ///
	addn("Notes: Data are from the NCRTS active workers in April 2016, see Table 1 for details.  The dependent variable is actively working as of December 2017." ///
	"A full list of covariates is provided in Appendix Table **** and includes years of service, race, education, number of children, type of public employer, salary, and age dummies.") ///
	title(Table 2: The Probability of Continued Work by Pension Eligibility Status)


***********************************************************
*** Table 5: Own Health and Retiree Health Insurance Access
***********************************************************

global demo "svy3_own_health_poor svy3_sphlthpoor svy3_married_partner admin3_female age2-age13 admin3_int_yos svy3_num_kids_12 svy3_num_kids_34 svy3_num_kids_miss svy3_race_black svy3_race_hisp svy3_race_other svy3_educ_ba admin3_atype_school admin3_atype_stategovt admin3_total_salary_10K_2015"
global pension "admin3_eligible_early_at_svy3 admin3_eligible_normal_at_svy3 admin5_status_not_ret admin3_eligible_none_at_svy5 admin3_eligible_early_at_svy5 admin3_just_eligible_normal_svy5 admin3_past_eligible_normal_svy5"


*** COL 1: Elig x own health TSERS

logit admin5_status_not_ret adminsvy3_interact_early_poor adminsvy3_interact_normal_poor  adminsvy3_interact_early_good adminsvy3_interact_normal_good $demo, robust
 
margins, dydx(*) post

sum admin5_status_not_ret if e(sample)==1
estadd scalar ymean = r(mean)

test adminsvy3_interact_early_poor = adminsvy3_interact_normal_poor 
estadd scalar pdiff_poor = r(p)

test adminsvy3_interact_early_good = adminsvy3_interact_normal_good 
estadd scalar pdiff_good = r(p)

test adminsvy3_interact_early_poor = adminsvy3_interact_early_good
estadd scalar pearly=r(p)

test adminsvy3_interact_normal_poor =adminsvy3_interact_normal_good
estadd scalar pnorm=r(p)

eststo col1_m


*** COL 2: X OWN HEALTH lGERS

logit admin5_status_not_ret adminsvy3_interact_early_poor adminsvy3_interact_normal_poor  adminsvy3_interact_early_good adminsvy3_interact_normal_good  ///
 $demo if svy3_own_has_rhi == 1, robust
 
margins, dydx(*) post

sum admin5_status_not_ret if e(sample)==1
estadd scalar ymean = r(mean)

test adminsvy3_interact_early_poor = adminsvy3_interact_normal_poor 
estadd scalar pdiff_poor = r(p)

test adminsvy3_interact_early_good = adminsvy3_interact_normal_good 
estadd scalar pdiff_good = r(p)

test adminsvy3_interact_early_poor = adminsvy3_interact_early_good
estadd scalar pearly=r(p)

test adminsvy3_interact_normal_poor =adminsvy3_interact_normal_good
estadd scalar pnorm=r(p)

eststo col2_m


*** Col 3

logit admin5_status_not_ret adminsvy3_interact_early_poor adminsvy3_interact_normal_poor  adminsvy3_interact_early_good adminsvy3_interact_normal_good  ///
 $demo if svy3_own_has_rhi == 0, robust
 
margins, dydx(*) post

sum admin5_status_not_ret if e(sample)==1
estadd scalar ymean = r(mean)

test adminsvy3_interact_early_poor = adminsvy3_interact_normal_poor 
estadd scalar pdiff_poor = r(p)

test adminsvy3_interact_early_good = adminsvy3_interact_normal_good 
estadd scalar pdiff_good = r(p)

test adminsvy3_interact_early_poor = adminsvy3_interact_early_good
estadd scalar pearly=r(p)

test adminsvy3_interact_normal_poor =adminsvy3_interact_normal_good
estadd scalar pnorm=r(p)

eststo col3_m


esttab col1_m col2_m col3_m using "${output}Tbl5_OwnHealth_HI.csv", replace lab se(3) b(3)  star(* 0.10 ** 0.05 *** 0.01) ///tbl_reg1
	 mtitle("" "Yes" "No/DK/Missing") sca("ymean Mean of Dep Var"  ///
	"pdiff_poor Poor Health: Early = Normal" "pdiff_good Good Health: Early = Normal" ///
	"pearly  Early: Poor Health = Good Health " "pnorm Normal: Poor Health = Good Health") ///
	 order( adminsvy3_interact_early_poor adminsvy3_interact_normal_poor  adminsvy3_interact_early_good adminsvy3_interact_normal_good ///
	svy3_own_health_poor svy3_sphlthpoor svy3_married_partner admin3_female) ///
	keep(adminsvy3_interact_early_poor adminsvy3_interact_normal_poor  adminsvy3_interact_early_good adminsvy3_interact_normal_good ///
	svy3_own_health_poor svy3_sphlthpoor svy3_married_partner admin3_female) margin ///
	addn("Notes: Data are from the NCRTS active workers in April 2016, see Table 1 for details.  The dependent variable is actively working as of December 2017." ///
	"A full list of covariates is provided in Appendix Table **** and includes years of service, race, education, number of children, type of public employer, salary, and age dummies.") ///
	title(Table 5: Own Health and Retiree Health Insurance Access) 


***********************************************************
*** Table 6: Spouseâ€™s Health and Health Insurance Access
***********************************************************


keep if svy3_married_partner == 1

*** COL 1: X SP HEALTH

	gen adminsvy3_interact_early_spoor = svy3_sphlthpoor*admin3_eligible_early_at_svy5  //if svy3_married_partner == 1
	lab var adminsvy3_interact_early_spoor "Elig early * Spouse poor health"
	
	gen adminsvy3_interact_early_sgood = (1-svy3_sphlthpoor)*admin3_eligible_early_at_svy5 // if svy3_married_partner == 1
	lab var adminsvy3_interact_early_sgood "Elig early * Spouse good health"
	
	gen adminsvy3_interact_normal_spoor = svy3_sphlthpoor*admin3_eligible_normal_at_svy5 // if svy3_married_partner == 1
	lab var adminsvy3_interact_normal_spoor "Elig normal * Spouse poor health"
	
	gen adminsvy3_interact_normal_sgood = (1-svy3_sphlthpoor)*admin3_eligible_normal_at_svy5 //if svy3_married_partner == 1
	lab var adminsvy3_interact_normal_sgood "Elig normal * Spouse good health"


global demo "svy3_own_health_poor svy3_sphlthpoor svy3_married_partner admin3_female age2-age13 admin3_int_yos svy3_num_kids_12 svy3_num_kids_34 svy3_num_kids_miss svy3_race_black svy3_race_hisp svy3_race_other svy3_educ_ba admin3_atype_school admin3_atype_stategovt admin3_total_salary_10K_2015"
global pension "admin3_eligible_early_at_svy3 admin3_eligible_normal_at_svy3 admin5_status_not_ret admin3_eligible_none_at_svy5 admin3_eligible_early_at_svy5 admin3_just_eligible_normal_svy5 admin3_past_eligible_normal_svy5"


logit admin5_status_not_ret adminsvy3_interact_early_spoor adminsvy3_interact_normal_spoor  adminsvy3_interact_early_sgood adminsvy3_interact_normal_sgood  ///
 $demo, robust
 
margins, dydx(*) post

sum admin5_status_not_ret if e(sample)==1
estadd scalar ymean = r(mean)

test adminsvy3_interact_early_spoor = adminsvy3_interact_normal_spoor 
estadd scalar pdiff_spoor = r(p)

test adminsvy3_interact_early_sgood = adminsvy3_interact_normal_sgood 
estadd scalar pdiff_sgood = r(p)

test adminsvy3_interact_early_spoor = adminsvy3_interact_early_sgood
estadd scalar pearlys=r(p)

test adminsvy3_interact_normal_spoor =adminsvy3_interact_normal_sgood
estadd scalar pnorms=r(p)

eststo col1_m


*** COL 2

/* sources of spouse health insurance 
v129 - own employer
v130 - my employer
v131 RHI previous
v132 - RHI from my employer
v133 RHI from my prev
v134 mediacaid
v135 other

*my employer: rhi_spcurr
*other insurance: (sp_hashi not rhi_spcurr)
*no insurance
gen sp_resp_ehi = v130 == "Yes" | v132 == "Yes"svy3_sp_resp_ehi

gen sp_hashi = (v129 == "Yes" | v130 == "Yes" | v131 == "Yes" | v132 == "Yes" | v133 == "Yes" | v134 == "Yes" | v135 == "Yes")
tab sp_hashi lgers, row col cell
*tab rhi_spcurr lgers, row col cell

sum v13*

* RESPONDENT HI 
*gen sp_hi_oth = sp_hashi == 1 & rhi_spcurr == 0*/


logit admin5_status_not_ret adminsvy3_interact_early_spoor adminsvy3_interact_normal_spoor  adminsvy3_interact_early_sgood adminsvy3_interact_normal_sgood  ///
 $demo if svy3_sp_resp_ehi == 1, robust
 
margins, dydx(*) post

sum admin5_status_not_ret if e(sample)==1
estadd scalar ymean = r(mean)

test adminsvy3_interact_early_spoor = adminsvy3_interact_normal_spoor 
estadd scalar pdiff_spoor = r(p)

test adminsvy3_interact_early_sgood = adminsvy3_interact_normal_sgood 
estadd scalar pdiff_sgood = r(p)

test adminsvy3_interact_early_spoor = adminsvy3_interact_early_sgood
estadd scalar pearlys=r(p)

test adminsvy3_interact_normal_spoor =adminsvy3_interact_normal_sgood
estadd scalar pnorms=r(p)

eststo col2_m



*** COL3

logit admin5_status_not_ret adminsvy3_interact_early_spoor adminsvy3_interact_normal_spoor  adminsvy3_interact_early_sgood adminsvy3_interact_normal_sgood  ///
 $demo if svy3_sp_resp_ehi == 0, robust
 
margins, dydx(*) post

sum admin5_status_not_ret if e(sample)==1
estadd scalar ymean = r(mean)

test adminsvy3_interact_early_spoor = adminsvy3_interact_normal_spoor 
estadd scalar pdiff_spoor = r(p)

test adminsvy3_interact_early_sgood = adminsvy3_interact_normal_sgood 
estadd scalar pdiff_sgood = r(p)

test adminsvy3_interact_early_spoor = adminsvy3_interact_early_sgood
estadd scalar pearlys=r(p)

test adminsvy3_interact_normal_spoor =adminsvy3_interact_normal_sgood
estadd scalar pnorms=r(p)
eststo col3_m


esttab col1_m col2_m col3_m using "${output}Tbl6_SpHealth_HI.csv", replace lab se(3) b(3)  star(* 0.10 ** 0.05 *** 0.01) ///tbl_reg1
	 mtitle("" "Yes" "No") sca("ymean Mean of Dep Var"  ///
	"pdiff_spoor Sp Poor Health: Early = Normal" "pdiff_sgood Sp Good Health: Early = Normal" ///
	"pearlys  Early: Sp Poor Health = Sp Good Health " "pnorms Normal: Sp Poor Health = Sp Good Health") ///
	 order( adminsvy3_interact_early_spoor adminsvy3_interact_normal_spoor  adminsvy3_interact_early_sgood adminsvy3_interact_normal_sgood ///
	svy3_own_health_poor svy3_sphlthpoor svy3_sphlthpoor admin3_female) ///
	keep(adminsvy3_interact_early_spoor adminsvy3_interact_normal_spoor  adminsvy3_interact_early_sgood adminsvy3_interact_normal_sgood ///
	svy3_own_health_poor svy3_sphlthpoor svy3_sphlthpoor admin3_female) margin ///
	addn("Notes: Data are from the NCRTS active workers in April 2016, see Table 1 for details.  The dependent variable is actively working as of December 2017." ///
	"A full list of covariates is provided in Appendix Table **** and includes years of service, race, education, number of children, type of public employer, salary, and age dummies.") ///
	title(Table 6: Spouse's Health and Health Insurance Access) 


exit
















*** COL 2: Eligibility X Spouse Health


logit admin5_status_not_ret adminsvy3_interact_early_poor adminsvy3_interact_normal_poor  adminsvy3_interact_early_good adminsvy3_interact_normal_good ///
adminsvy3_interact_early_spoor adminsvy3_interact_early_sgood adminsvy3_interact_normal_spoor adminsvy3_interact_normal_sgood  ///
 $demo, robust
 
margins, dydx(*) post

sum admin5_status_not_ret if e(sample)==1
estadd r(mean)

test adminsvy3_interact_early_spoor = adminsvy3_interact_normal_spoor 
estadd scalar pdiff_spoor = r(p)

test adminsvy3_interact_early_sgood = adminsvy3_interact_normal_sgood 
estadd scalar pdiff_sgood = r(p)

test adminsvy3_interact_early_spoor = adminsvy3_interact_early_sgood
estadd scalar pearlys=r(p)

test adminsvy3_interact_normal_spoor =adminsvy3_interact_normal_sgood
estadd scalar pnorms=r(p)

eststo col3_m
exit
**** Heath X Eligibility



*** EHI X Eligibility
	gen adminsvy3_interact_early_ehi = admin3_eligible_early_at_svy5*svy3_sp_resp_ehi
	gen adminsvy3_interact_norm_ehi = admin3_eligible_normal_at_svy5*svy3_sp_resp_ehi
	gen adminsvy3_interact_early_notehi = admin3_eligible_early_at_svy5*(1-svy3_sp_resp_ehi)
	gen adminsvy3_interact_norm_notehi = admin3_eligible_normal_at_svy5*(1-svy3_sp_resp_ehi)	

	
*** Life expectation X Eligibility
	gen adminsvy3_interact_early_low_le = svy3_low_own_life_expect*admin3_eligible_early_at_svy5
	gen adminsvy3_interact_norm_low_le = svy3_low_own_life_expect*admin3_eligible_normal_at_svy5
	gen adminsvy3_interact_early_high_le = (1-svy3_low_own_life_expect)*admin3_eligible_early_at_svy5
	gen adminsvy3_interact_norm_high_le = (1-svy3_low_own_life_expect)*admin3_eligible_normal_at_svy5
	
	
*** Health insurance importance X Eligibility 
	gen adminsvy3_interact_early_imp = svy3_health_ins_important*admin3_eligible_early_at_svy5
	gen adminsvy3_interact_norm_imp = svy3_health_ins_important*admin3_eligible_normal_at_svy5
	gen adminsvy3_interact_early_notimp = (1-svy3_health_ins_important)*admin3_eligible_early_at_svy5
	gen adminsvy3_interact_norm_notimp = (1-svy3_health_ins_important)*admin3_eligible_normal_at_svy5
	
	
*** Peak difference X Eligibility
	*gen adminsvy3_interact_peak_poor = peakdiff*svy3_own_health_poor
	*gen adminsvy3_interact_peak_good = peakdiff*(1 -svy3_own_health_poor)

